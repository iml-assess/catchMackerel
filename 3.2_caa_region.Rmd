---
title: "Catch-at-age: by region"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: FALSE
    code_folding: show
    number_sections: TRUE
---
    
# Catch-at-age: by region

# SET-UP
```{r markdown, echo=F}
library(knitr)
opts_chunk$set(echo = T, collapse = T, fig.align = "center", fig.width = 9, fig.height = 6)
options(width = 120)
```    
## settings
```{r settings, message = F}
source('0.0_settings.R')
```
## load all data
```{r data, message = F}
load(paste0(dir.rdat, "catch.caa.Rdata"))
load(paste0(dir.rdat, "lf.caa.Rdata"))
load(paste0(dir.rdat, "bio.caa.Rdata"))
load(paste0(dir.rdat, "lw.mod.Rdata"))
lf.caa[,which(names(lf.caa) %in% names(lw.mod)[-c(1:2)])] <- NULL       # remove model details
catch.caa <- catch.caa[catch.caa$year %in% unique(lf.caa$year),]        # years for which bio/lf
```

# CATCH-AT-AGE BY REGION

From the tables of length-frequencies/bio samples by region it is clear that insufficient samples are available to cover all regions. 
Only keep eNL, wNL, sGSL and SS. Only the sGSL has samples each year.

```{r caa regional, message = F, fig.height = 6,fig.width = 8}
caa.all.regR <- paste0(dir.rdat, "caa.all.reg.Rdata")
caa.regR <- paste0(dir.rdat, "caa.reg.Rdata")
  
these.regions <- c('SS','sGSL','wNL','eNL')

if(!all(file.exists(c(caa.all.regR,caa.regR)))){
    # step 1) get samples
  
  caa.all.reg <- ldply(these.regions,function(x){
        lf.reg <- lf.caa[lf.caa$region==x & !is.na(lf.caa$region),]
        al.reg <- bio.caa[bio.caa$region==x & !is.na(bio.caa$region),]
        ca.reg <- catch.caa[catch.caa$region==x & !is.na(catch.caa$region),]
                                              
        caa.all <- caa.raw(catch=ca.reg,
                           lf=lf.reg, 
                           al=al.reg,
                           tresh.lf=2,          # min samples for length-frequency
                           tresh.al=2,          # min samples for age-length key
                           period.unit='quarter')   # quarterly grouping instead of monthly
    
        caa.all$X0 <- NULL                       # remove age 0 ?? (total landings somewhat smaller)
        caa.all <- caa.all[caa.all$length!=-1,]  # remove instances where treshold not reached
        return(caa.all)
  })
  save(caa.all.reg, file =  caa.all.regR)
  
  caa.reg <- ddply(caa.all.reg,c('region'),function(x){caa.clean(x,plus=10)})

  save(caa.reg, file =  caa.regR)
}else{ 
    load(caa.regR)
    load(caa.all.regR)
}

```

## CHECK {.tabset}
### samples
```{r caa check samples, fig.height = 6,fig.width = 12}
check <- ddply(caa.all.reg,c('id','region'),summarise,
               option.lengthfreq=unique(option.lengthfreq),
               nsample.lengthfreq=unique(nsample.lengthfreq),
               nfish.lengthfreq=sum(n.lf),
               option.agelength=unique(option.agelength),
               nsample.agelength=unique(nsample.agelength),
               nfish.agekey=sum(n.agekey))
check <- melt(check,id=c('id','region'))
ggplot(check,aes(x=value))+geom_histogram(bins=30)+facet_grid(region~variable,scale='free')  # region and gear can only rarely be matched
```

### total
```{r caa check total, fig.height = 6,fig.width = 8}
tot <- ddply(catch.caa[catch.caa$region %in% these.regions,],c('year','region'),summarise,catch=sum(catch))
ggplot(caa.reg,aes(x=year))+
  geom_bar(stat='identity',aes(y=caaw,fill=age))+
  geom_line(data=tot,aes(y=catch))+
  facet_wrap(~region,scale='free_y')+
  scale_fill_viridis()

```

# PLOTS {.tabset}
## CAAN abs
```{r caan plot, message = F, fig.height = 6,fig.width = 12}
ggplot(caa.reg,aes(x=year,y=age,size=caan))+
  geom_point(alpha=0.8)+ scale_size(range = c(1,10))+
  facet_wrap(~region)
```

## CAAN rel
```{r caan rel, message = F, fig.height = 6,fig.width = 12}
df <- caa.reg[!is.na(caa.reg$caan),]
df <- ddply(df,c('year','region'),mutate,caan.rel=caan/max(caan))
ggplot(df,aes(x=year,y=age,size=caan.rel))+
  geom_point(alpha=0.8)+ 
  scale_size(range = c(1,7))+
  facet_wrap(~region)
```

## CAAN arrow
```{r caan arrow, message = F, fig.height = 6,fig.width = 12}
df <- caa.reg[!is.na(caa.reg$caan),]
df <- ddply(df,c('year','region'),mutate,caan.rel=caan/max(caan))

m <- acast(df[df$region=='sGSL',],age~year,value.var = 'caan.rel')
a <- cohort(m)
a <- a[a$strength>=quantile(a$strength, 0.8, na.rm=TRUE),]   # 20% strongest years in the southern gulf
a$age <- min(df$age)
a$agemax <- max(df$age)
a$yearend <- a$year+max(df$age)-min(df$age)
a$label <- a$year-min(df$age)

ggplot(df,aes(x=year,y=age))+
  geom_point(alpha=0.8,aes(size=caan.rel))+ 
  scale_size(range = c(1,7))+
  facet_wrap(~region)+
  geom_segment(data=a,aes(xend=yearend,yend=agemax),col='darkblue',size=1)+
  geom_text(data=a,aes(x=yearend,y=agemax,label=label),col='darkblue',size=3,hjust=0,vjust=0)+
  coord_cartesian(xlim=range(df$year))
```

## CAAW
```{r caaw plot, message = F, fig.height = 6,fig.width = 16}
ggplot(caa.reg,aes(x=year,y=age,size=caaw))+
  geom_point(alpha=0.8)+ scale_size(range = c(1,10))+
  facet_wrap(~region)
```

## WAA
```{r waa plot, message = F, fig.height = 6,fig.width = 16}
ggplot(caa.reg,aes(x=year,y=waa,group=age))+
    geom_line(aes(color=age),size=1)+
    facet_wrap(~region)+
    scale_color_viridis()
```

